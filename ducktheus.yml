version: 1

debug: false
port: 9100
db: ducktheus.db

sources:
  - name: snowflake_query_history
    type: parquet
    source: assets/snowflake_query_history.parquet
    refreshIntervalSeconds: 5

  # - name: united_states_zip_codes
  #   type: sql
  #   source: select * from read_csv_auto('https://raw.githubusercontent.com/scpike/us-state-county-zip/refs/heads/master/geo-data.csv')
  #   refreshIntervalSeconds: 1000

metrics:
  - name: queries_this_week_total
    help: Queries this week total, by user and warehouse
    enabled: true
    sql: select struct_pack(user :=  user_name, warehouse := warehouse_name) as labels, count(*) as value from snowflake_query_history group by 1;
    labels:
      - user
      - warehouse

  - name: avg_query_duration_seconds
    help: The average query duration for a particular user, using a particular warehouse
    enabled: true
    sql: select struct_pack(user :=  user_name, warehouse := warehouse_name) as labels, avg(TOTAL_ELAPSED_TIME) as value from snowflake_query_history group by 1;
    labels:
      - user
      - warehouse

  - name: table_operations_count
    help: The number of operations on each table over the last week
    enabled: true
    sql: select struct_pack(user := user_name, query_type := query_type) as labels, count(*) as value from snowflake_query_history group by 1;
    labels:
      - user
      - query_type

  - name: avg_virtual_warehouse_spill_to_local_storage_bytes
    help: The average bytes spilled to disk for queries on a specific warehouse
    enabled: true
    sql: select struct_pack(user :=  user_name, warehouse := warehouse_name) as labels, avg(BYTES_SPILLED_TO_LOCAL_STORAGE) as value from snowflake_query_history group by 1;
    labels:
      - user
      - warehouse

  - name: avg_virtual_warehouse_spill_to_remote_storage_bytes
    help: The average bytes spilled to remote disk for queries on a specific warehouse
    enabled: true
    sql: select struct_pack(user :=  user_name, warehouse := warehouse_name) as labels, avg(BYTES_SPILLED_TO_REMOTE_STORAGE) as value from snowflake_query_history group by 1;
    labels:
      - user
      - warehouse

  # - name: united_states_zip_codes_total
  #   help: The number of US zip codes
  #   type: gauge
  #   sql: select struct_pack(state := state) as labels, count(*) as value from united_states_zip_codes group by 1;
  #   labels:
  #     - state
