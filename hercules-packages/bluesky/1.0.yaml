name: bluesky-duckdb
version: 1.0

sources:
  - name: profile
    type: sql
    source: select * from read_json_auto('https://public.api.bsky.app/xrpc/app.bsky.actor.getProfile?actor=duckdb.org');
    materialize: true
    refreshIntervalSeconds: 60

  - name: posts
    type: sql
    source: select post.* from (select unnest(feed).post as post from (select * from read_json_auto('https://public.api.bsky.app/xrpc/app.bsky.feed.getAuthorFeed?actor=did:plc:id67xmpji7oysb7vitsodr4v')));
    materialize: true
    refreshIntervalSeconds: 60

metrics:
  gauge:
    - name: associated_starter_packs_total
      help: The number of starter packs the DuckDB Bluesky account is associated with
      sql: select associated.starterPacks as val from profile;

    - name: followers_total
      help: The number of total accounts following DuckDB
      sql: select followersCount as val from profile;

    - name: follows_total
      help: The number of total accounts the DuckDB Bluesky account follows
      sql: select followsCount as val from profile;

    - name: posts_total
      help: The number of total DuckDB-authored Bluesky posts
      sql: select postsCount as val from profile;

    - name: reply_count
      help: The number of total replies to DuckDB Bluesky posts
      sql: select sum(replyCount) from posts;

    - name: repost_count
      help: The number of total reposts to DuckDB Bluesky posts
      sql: select sum(repostCount) from posts;

    - name: like_count
      help: The number of total likes to DuckDB Bluesky posts
      sql: select sum(likeCount) from posts;

    - name: quote_count
      help: The number of total quoted DuckDB Bluesky posts
      sql: select sum(quoteCount) from posts;

    - name: author_posts_count
      help: The number of posts on the DuckDB Bluesky account by author
      sql: select author.handle, count(*) from posts group by 1;

    - name: author_likes_count
      help: The number of likes on DuckDB Bluesky posts by author
      sql: select author.handle, sum(likeCount) from posts group by 1;

  summary:
    - name: author_post_likes_count
      help: Quantiles of likes on DuckDB Bluesky posts by author
      sql: select author.handle, likeCount as val from posts;
      objectives:
        - 0.5
        - 0.9
        - 0.99

    - name: author_post_repost_count
      help: Quantiles of reposts on DuckDB Bluesky posts by author
      sql: select author.handle, repostCount as val from posts;
      objectives:
        - 0.5
        - 0.9
        - 0.99
